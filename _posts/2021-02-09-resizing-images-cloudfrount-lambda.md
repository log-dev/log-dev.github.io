---
layout: post
title: "Real-time image resizing with AWS Lambda@edge (Lambda@edge)"
author: "Logger"
thumbnail: "https://heropy.blog/css/images/vendor_icons/aws.png"
tags: 
---


![image](https://heropy.blog/css/images/vendor_icons/aws.png)

# Changes

## December 2019

- Added information about the revision check of the CloudWatch log.

## August, 2019

- Added limitations for Lambda@Edge.
- Added exception processing code for `response.body` greater than 1MB.
- Added an exception handling method for GIF conversion issues in Sharp Library.
- I added an easier way to publish a new version of Lambda.
- Added a method for invalidating objects (files) in CloudFront Cache.

# Resizing real-time images with AWS Lambda@edge

Lambda@Edge is one of the features of Amazon CloudFront that can be configured to provision servers, upload code (Node.js) to AWS Lambda, and trigger functions closer to the user in response to requests.

Using Lambda@Edge, we would like to configure the following querying options to change the size (w, h), quality (q), and file format (format, f) of the image in real time as requested:

```undefined
https://heropy.blog/heropy.png?w=150
```

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/Lambda@Edge%20for%20Image%20Resizing.jpg)

# creating IAM policies and roles

## Create Policy

Set IAM permissions to associate Lambda with CloudFront deployment (Deploy).

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/iam-policy.jpg)

- The `s3:PutObject` privilege is not required.
- Set either `cloudfront:CreateDistribution` or `cloudfront:UpdateDistribution`.
- Set the `logs:xxx` privileges to process log data in CloudWatch.

### IAM / Policies

- Select Create Policy.
- Select `JSON` to enter the policy below.
- Create a name (`ResizingImages`) and a description for the policy.
- Create Policy!

```undefined
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "VisualEditor0",
"Effect": "Allow",
"Action": [
"iam:CreateServiceLinkedRole",
"lambda:GetFunction",
"lambda:EnableReplication",
"cloudfront:UpdateDistribution",
"s3:GetObject",
"logs:CreateLogGroup",
"logs:CreateLogStream",
"logs:PutLogEvents",
"logs:DescribeLogStreams"
],
"Resource": "*"
}
]
}

```

## Create Role

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/iam-role.jpg)

### IAM / Roles

- Select `Create Role` to proceed as follows:
Select `Lambda` as the `Service to use this role`.
Select the policy `ResizingImages` that you created at the top of the list.
Create a name for the role (`ResizingImages`) and a description.
Make a Role!
- Select `Lambda` as the `Service to use this role`.
- Select the policy `ResizingImages` that you created at the top of the list.
- Create a name for the role (`ResizingImages`) and a description.
- Make a Role!

Modify IAM roles to delegate privileges to service security principals `lambda.amazonaws.com` and `edgelambda.amazonaws.com`.

- Select the `ResizingImages` you just created from the list of my roles.
- On the Trust Relationship tab, select Edit Trust Relationship.
- Enter the trust relationship information below.
- `Trust Policy Update`!

```undefined
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Service": [
"edgelambda.amazonaws.com",
"lambda.amazonaws.com"
]
},
"Action": "sts:AssumeRole"
}
]
}

```

# Verify S3 Settings

- The region of the bucket does not matter.
- After setting up CloudFront, you can check if CloudFront`s Origin Access Identity is connected by the "CloudFront Origin Access Identity" in the bucket "Authorization/Bucket Policy".
- The bucket may require `public` access for testing.
- The AWS account that owns the bucket must also own the object.
- The requested object must exist in the bucket.
- Upload the `favicon.ico` file to the bucket Root path. S3 Favicon error may occur.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/s3-favicon-error.jpg)

# Creating a Lambda function

Be aware of restrictions on the following Lambda@Edge:

<table><thead><tr><th>entity</th><th>Limit origin request and<br>response events</th><th>Limit end user requests and<br>response events</th>
 </tr></thead><tbody><tr><td>Allocate function resource</td><td>Same as Lambda limit</td><td>128MB</td></tr><tr>
 <td>Function timeout</td><td>30 seconds</td><td>5 seconds</td></tr><tr><td>Response generated by the Lambda function, including header and body
 Size of</td><td>1MB</td><td>40KB</td></tr><tr><td>Maximum compressed size of Lambda functions and included libraries</td><td>50MB
 </td><td>1MB</td></tr></tbody></table>

 

- Only `US-East-1` (northern Virginia) is allowed in the Lambda@Edge.
- Select `Create Function` to set:
Enter a function name (`ResizingImages`).
Select the runtime (`Node.js 10.x`).
`Select or create an execution role`
Execution role: `Use existing role`
Existing role: `ResizingImages`
- Enter a function name (`ResizingImages`).
- Select the runtime (`Node.js 10.x`).
- `Select or create an execution role`
Execution role: `Use existing role`
Existing role: `ResizingImages`
- Execution role: `Use existing role`
- Existing role: `ResizingImages`
- "Function generation"!
- Setting the `time-out` to `3 seconds` may prevent resizing if the initial request (Cache miss) has more operations. Set to `10 seconds`.
- `Save`! (top right of screen)

After setting up the revision as `Asia Pacific (Seoul)`, not `Eastern US (North Virginia),`, the error message went like this!

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/lambda-function-region-error.jpg)

# Creating a Lambda function using Cloud 9

I set up the lambda code in the local macOS and upload it as a zip file.

```bash
"'darwin-x64' binaries cannot be used on the 'linux-x64' platform. Please remove the 'node_modules/sharp/vendor' directory and run 'npm install'."

```

The error message is displayed.
The Sharp binary in the `node_modules` directory must be set for the `linux-x64` platform.
You can clone and use an environment that matches lambda runtime with docker-lambda.
However, I used Cloud 9 because I wanted to write it without any other method of zip.

You only need to install Sharp for the module.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloud9-details.jpg)

### Cloud 9 / Your environments

Set up a new Cloud 9 environment to write Lambda code.

> Seoul Region is not supported yet.

- Select `Create environment`.
- Type a Name (`ResizingImages`) and a Description in the Name environment.
- Configuration settings have been set as follows:
Create a new instance for environment (EC2)
t2.micro (1 GiB RAM + 1 vCPU)
Amazon Linux
After 30 minutes (default)
- Create a new instance for environment (EC2)
- t2.micro (1 GiB RAM + 1 vCPU)
- Amazon Linux
- After 30 minutes (default)
- `Create environment`!

The Lambda function that we created above is called Cloud 9 environment.

- Select `AWS Resources` from the top-right menu of the screen.
- Lambda(us-east-1)/`Remote Functions` 목록의 `ResizingImages`를 `Import`합니다.
- Use Terminal to access the imported Lambda function (create `package.json` and install the Sharp module).
`$ cd ResizingImages`
`$ npm init -y`
`$ npm i sharp`
- `$ cd ResizingImages`
- `$ npm init -y`
- `$ npm i sharp`
- Modify `index.js` as shown in the code below.
- Distribute the Lambda function you created as a `$LATEST` version.
Lambda(us-east-1)/`Local Functions` 목록의 `ResizingImages`를 `Deploy`합니다.
- Lambda(us-east-1)/`Local Functions` 목록의 `ResizingImages`를 `Deploy`합니다.

```js
'use strict';

const querystring = require('querystring'); // Don't install.
const AWS = require('aws-sdk'); // Don't install.
const Sharp = require('sharp');

const S3 = new AWS.S3({
region: '<YOUR_BUCKET_REGION>'
});
const BUCKET = '<YOUR_BUCKET_NAME>';

exports.handler = async (event, context, callback) => {
const { request, response } = event.Records[0].cf;
// Parameters are w, h, f, q and indicate width, height, format and quality.
const params = querystring.parse(request.querystring);

// Required width or height value.
if (!params.w
```

If you use the GIF format, you can make an exception to return it as it was.

> Sharp Library has identified a problem resizing the GIF format to GIF.
Related issues can be found at https://github.com/lovell/sharp/issues/1372.

```js
// Exception '.gif' image.
if (extension === 'gif') {
console.log('GIF image requested!');
return callback(null, response);
}

```

You can also process only if you do not have the following format to convert:

```js
if (extension === 'gif'
```

Alternatively, CloudFront can handle exceptions.

> Watch out for the sequence of cache operations!

- Select to move the distribution cloudfront
- On the `Behaviors` tab, select `Create Behavior`.
- Modify as follows and `Create`!
Path Pattern: `*.gif`
Compress Objects Automatically: `Yes`
- Path Pattern: `*.gif`
- Compress Objects Automatically: `Yes`

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloudfront-create-behavior-gif.jpg)

# Publish new version of Lambda

Lambda@Edge is not available with the $LATEST version, publishing a new version to connect to CloudFront.
If you have modified the content, you must publish the modified version and connect it to CloudFront.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/lambda-create-new-version.jpg)

### Lambda / Function

- Select `ResizingImages` from the function list.
- From the top right menu, select `Publish New Version` under `Task`.
- Type `version description` of `publishing a new version of $LATEST` and `publish` a new version.
- Copy a new published version of the ARN (`ARN - arn:aws:lambda~~~:ResizingImages:1`, upper right of the screen) and connect to CloudFront.

If you have modified Lambda, publish the new version and associate it with CloudFront as follows:

- Copy a new published version of the ARN (`ARN - arn:aws:lambda~~~:ResizingImages:2`, upper right of the screen).
- Select to move the distribution cloudfront
- On the `Behaviors` tab, check the default Behavior and select `Edit`.
- Modify as follows and "Yes, Edit"!
Lambda Function Associations:
Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:2`)
- Lambda Function Associations:
Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:2`)
- Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:2`)

If you have modified Lambda, you can publish the new version more easily and associate it with CloudFront.

> CloudFront settings are required in advance.

- In the modified version of $LATEST, under Actions, select `Deploy Lambda@Edge`.
- Select `Use existing CloudFront trigger` for this function, check its contents, and then `deploy`.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/lambda-cloudfront-use-trigger-existing.jpg)

When you configure a new trigger, you can set it as follows:

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/lambda-cloudfront-use-trigger-new.jpg)

# CloudFront

### CloudFront / Distributions

- Select `Create Distribution`.
- Select `Get Started` in the Web and set it up as follows:
Origin Domain Name: AWS S3 Bucket to Import Web Content
RESTRICT BUCKET ACCESS: `Yes` (Always requires S3 access with CloudFront URL)
Origin Access Identity: `Create a New Identity`
Grant Read Permissions on Bucket: `Yes, Update Bucket Policy` (CloudFront accesses and updates S3`s bucket policy)
Query String Forwarding and Caching: `Forward all, cache based on whitelist`
Query String Whitelist: `w`, `h`, `f`, `q` (defined querying parameters for CloudFront to use)
Compression Objects Automatically: `Yes` (Contents compressed for `Accept-Encoding: gzip` requests)
Lambda Function Associations:
CloudFront Event: `Origin Response`
Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:1`)
Comment: `ResizingImages` (a short name/description for distinction of distribution)
- Origin Domain Name: AWS S3 Bucket to Import Web Content
- RESTRICT BUCKET ACCESS: `Yes` (Always requires S3 access with CloudFront URL)
- Origin Access Identity: `Create a New Identity`
- Grant Read Permissions on Bucket: `Yes, Update Bucket Policy` (CloudFront accesses and updates S3`s bucket policy)
- Query String Forwarding and Caching: `Forward all, cache based on whitelist`
- Query String Whitelist: `w`, `h`, `f`, `q` (defined querying parameters for CloudFront to use)
- Compression Objects Automatically: `Yes` (Contents compressed for `Accept-Encoding: gzip` requests)
- Lambda Function Associations:
CloudFront Event: `Origin Response`
Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:1`)
- CloudFront Event: `Origin Response`
- Lambda Function ARN: ARN input copied from Lambda function (`arn:aws:lambda~~~:ResizingImages:1`)
- Comment: `ResizingImages` (a short name/description for distinction of distribution)
- `Create Distribution`!

Please check `Status` of Distribution. It takes about 10 to 15 minutes to change from `In Progress` to `Deployed`.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloudfront-status-in-progress.jpg)

Using an alternate domain name (CNAME) in the CloudFront setting causes CloudFront to use its own domain name (for example, www.heropy.blog) instead of the domain name for deployment.
This post does not specify an alternate domain.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloudfront-cname.jpg)

# Check.

When CloudFront Distribution is complete, you can access the image with the CloudFront Domain Name as shown in the following example:

```undefined
d2d73zr4p2zskr.cloudfront.net/heropy.png?w=120
```

> Be careful not to reorder the querying!

# View CloudWatch Logs

CloudWatch lets you view logs that occur in lambda functions.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloudwatch-logs.jpg)

When you deploy Lambda@Edge, it replicates its function to AWS revisions around the world, so you need to check the logs of the Lambda in the requested revisions.
Therefore, you can check the general CloudWatch log in Seoul Region.

Start Creating and Using the Lambda@Edge Function

![image](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/images/lambda-creation-workflow-aws-location.png)

# Cache miss vs Cache hit

In one test, the original image (500x500px) of the PNG format is changed to a WEBP format of 555px size.
`5.26s` for `Cache miss` and `31ms` for `Cache hit`.

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cache-miss-vs-cache-hitrequest-time.jpg)

## Invalidate files from CloudFront edge cache

If you need to remove a file from the CloudFront edge cache before it expires, set it as follows:

- Select to move the distribution cloudfront
- On the `Invalidations` tab, select `Create Validation`.
- In Object Paths, enter the path.
E.g. `/heropy.png`, `/*`, `/images/*`
- E.g. `/heropy.png`, `/*`, `/images/*`
- `Invalidate`!

![image](https://heropy.blog/images/screenshot/resizing-images-cloudfrount-lambda/cloudfront-invalidate-file.jpg)

# References

https://engineering.huiseoul.com/lambda-%ED%95%9C%EA%B0%9C%EB%A1%9C-%EB%A7%8C%EB%93%9C%EB%8A%94-on-demand-image-resizing-d48167cc1c31
https://ikso2000.tistory.com/106
https://medium.com/daangn/aws-lambda%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%8D%B8%EB%84%A4%EC%9D%BC-%EC%83%9D%EC%84%B1-%EA%B0%9C%EB%B0%9C-%ED%9B%84%EA%B8%B0-acc278d49980
https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3
https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-edge-permissions.html
https://jasonbla.tistory.com/5
https://github.com/lovell/sharp/issues/1372
https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-lambda-at-edge